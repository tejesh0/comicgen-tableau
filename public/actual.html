<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="Comicgen" content="Create data stories using comics" />
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" /> -->

  <link href="https://fonts.googleapis.com/css?family=Neucha&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/comicgen/dist/comicgen.min.css">
  <style>
    .cursor-pointer {
      cursor: pointer;
    }
    :root {
      --comic-caption-font: Neucha, 'Open Sans', cursive;
    }
  </style>
  <script src="/tableau.extensions.1.latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/comicgen@0.1.7/dist/comicgen.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js"></script>
  <link rel="apple-touch-icon" href="/logo192.png" />
  <link rel="manifest" href="/manifest.json" />
  <title>Comicgen Extension</title>
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>

  <div>
    <div class="comic-caption-top">Please Configure ComicGen from top-right Context Menu</div>
    <g class="new" height="360" width="300" scale="1.4" angle="straight"></g>
  </div>

  <script>
    (function () {
      let avatar_map = {
        "dey": {
          emotion_normal: "normal",
          emotion_laugh: "smile",
          emotion_sad: "tired",
          emotion_angry: "shocked",
          emotion_worried: "shocked",
          emotion_surprised: "hmmconfused",
          emotion_wink: "wink",
          pose_pointingright: "pointingright",
          pose_pointingup: "pointingup",
          pose_yuhoo: "yuhoo",
          pose_superperfect: "superperfect",
          pose_holdinglaptop: "holdinglaptop",
          pose_angryfrustrated: "angryfrustrated",
          pose_handsfolded: "handsfolded",
          pose_handsonhip: "handsonhip",
          pose_holdingbook: "holdingbook",
          pose_readingpaper: "readingpaper",
          pose_thumbsup: "thumbsup",
          pose_thinkinghmm: "thinkinghmm"
        },
        "dee": {
          emotion_normal: "smile",
          emotion_laugh: "smilehappy",
          emotion_sad: "sad",
          emotion_angry: "angryfrustrated",
          emotion_worried: "worried",
          emotion_surprised: "angryshouting",
          emotion_wink: "wink",
          pose_pointingright: "pointingright",
          pose_pointingup: "pointingup",
          pose_yuhoo: "yuhoo",
          pose_superperfect: "superperfect",
          pose_holdinglaptop: "holdinglaptop",
          pose_angryfrustrated: "angryfrustrated",
          pose_handsfolded: "handsfolded",
          pose_handsonhip: "handsonhip",
          pose_holdingbook: "holdingbook",
          pose_readingpaper: "readingpaper",
          pose_thumbsup: "thumbsup",
          pose_thinkinghmm: "thinkinghmm"
        }
      };
      let sheetListeners = {}
      let comicgenOptions;

      $(document).ready(function () {
        console.log('tableau extensions settings: ', tableau.extensions.settings)
        tableau.extensions.initializeAsync({ 'configure': configure }).then(function () {
          console.log('tableau extensions settings later: ', tableau.extensions.settings)
          const initialPayload = tableau.extensions.settings._settingsImpl._currentSettings
          callback(initialPayload.settings)
          tableau.extensions.settings.addEventListener(tableau.TableauEventType.SettingsChanged, (settingsEvent) => {

            console.log("settings udpated with payload as: ", settingsEvent )
            callback(settingsEvent)
          });
        });
      });

      function callback(closePayload) {
        console.log('closePayload', closePayload)
        comicgenOptions = JSON.parse(closePayload)
        reloadComicgen(comicgenOptions.comicgen)

        let sheetname = comicgenOptions.form.sheetname.value
        let worksheets = tableau.extensions.dashboardContent.dashboard.worksheets
        let worksheet = worksheets
          .find(sheet => sheet.name.trim() === sheetname.trim())
        worksheets.forEach(function (wrksht) {
          loadSelectedMarks(wrksht, worksheet)
        })
      }

      function reloadComicgen(opts) {
        var obj = Object.assign({}, opts)
        obj.name = opts.avatar
        comicgen('.new', obj)
        console.log('comicgenOptions.comicgen', obj)
        $('.comic-caption-top').html(opts.annotation)
      }

      function configure() {
        const baseURL = window.location.origin.includes('localhost:3000') ? window.location.origin : '.';

        const popupUrl = `${baseURL}/index.html`;
        // const initialPayload = tableau.extensions.settings._settingsImpl._currentSettings
        const initialPayload = ''
        tableau.extensions.ui.displayDialogAsync(popupUrl, initialPayload, { height: 500, width: 500 })
        .then(callback).catch((error) => {
          // One expected error condition is when the popup is closed by the user (meaning the user
          // clicks the 'X' in the top right of the dialog).  This can be checked for like so:
          switch (error.errorCode) {
            case tableau.ErrorCodes.DialogClosedByUser:
              console.log('Dialog was closed by user');
              break;
            default:
              console.log(error.message);
          }
        });
      }


      function loadSelectedMarks(worksheet, main_worksheet) {
        let markselectionEventListener

        // Call to get the selected marks for our sheet
        if (sheetListeners[worksheet.name]) {
          sheetListeners[worksheet.name]()
        }
        markselectionEventListener = worksheet.addEventListener(tableau.TableauEventType.MarkSelectionChanged, function () {
          main_worksheet.getSummaryDataAsync().then(summaryrefresh)
        })
        sheetListeners[worksheet.name] = markselectionEventListener
      }

      function summaryrefresh(marks) {
        console.log('summary refresh', marks, marks.columns)
        var worksheetData = marks.data[0]
        var cols = marks.columns.map(d => d._fieldName)
        var actual_emotion = worksheetData[cols.indexOf(comicgenOptions.form.emotionField.value)]._formattedValue.toLowerCase()
        comicgenOptions.comicgen['emotion'] = avatar_map[comicgenOptions.comicgen.avatar]['emotion_' + actual_emotion]
        comicgenOptions.comicgen['annotation'] = worksheetData[cols.indexOf(comicgenOptions.form.speechBubbleTextField.value)]._formattedValue.toLowerCase()

        reloadComicgen(comicgenOptions.comicgen)
      }

    })();

  </script>
</body>

</html>